<html>
  <head>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id="ytplayer"></div>
    <script type="text/javascript" src='./node_modules/obs-websocket-js/dist/obs-websocket.min.js'></script>
    <script type="text/javascript" src='./config.js'></script>

    <!-- obs controller -->
    <script>
      const obs = new OBSWebSocket();
      obs.connect({ address: 'localhost:4444'});

      obs.on('error', err => {
        console.error('socket error:', err);
      });

      function updateClipInfo(name, channel) {
        obs.send('SetTextFreetype2Properties', {
          source: 'ClipInfo',
          text: `${name}\nBy - ${channel}`
        });
        console.log('OBS Source updated');
      }

      function restartBrowser() {
        obs.send('SetSceneItemProperties', { // hide
          item: 'Browser',
          visible: false,
        }).then(() => {
          obs.send('SetSceneItemProperties', { //show
            item: 'Browser',
            visible: true,
          });
        });
      }

      function setStatusText(text) {
        // obs.send('SetTextFreetype2Properties', {
        //   item: 'StatusText',
        //   text,
        // });
      }
    </script>
    
    <!-- load google youtube api-->
    <script>
      function getNextVideo() {
        return new Promise((resolve, reject) => {
          fetch('http://localhost:3000/videos').then((output) => {
            output.json().then((output) => {
              console.log(`Retrieved next video id ${output.url}`)
              resolve(output);
            });
          }).catch((error) => {
            reject(error);
          });
        })
      }
      // 'w_j7HldwIas';
      
      let currentVideo;

      function googleApiClientReady() {
        getNextVideo().then((output) => {
          currentVideo = output;
          gapi.client.setApiKey(apiKey);
          gapi.client.load('youtube', 'v3').then((output) => {
            getVideoData(currentVideo.code).then((output) => {
              updateClipInfo(output.title, output.channelTitle);
            }).catch((error) => {
              console.error(error);
            });
          }).catch((error) => {
            console.error(error);
          });
        });
        
      }

      function getVideoData(id) {
        return new Promise((resolve, reject) => {
          gapi.client.youtube.videos.list({
            part: 'snippet',
            id,
          }).then((output) => {
            const data = JSON.parse(output.body).items[0].snippet;
            resolve(data);
          }).catch((error) => {
            reject(error);
          });
        });
      }
    </script>
    <script src='https://apis.google.com/js/client.js?onload=googleApiClientReady'></script>
    
    <script>
      function nextVideo() {
        // get next video id from db
        getNextVideo().then((output) => {
          currentVideo = output;
          console.log(output)
          // get video info
          getVideoData(output.code).then((output) => {
            // update the ClipInfo text
            setStatusText(' ');
            updateClipInfo(output.title, output.channelTitle);
          }).catch((error) => {
            updateClipInfo('Unable to get clip info', 'ERROR');
            console.error(error);
            return;
          }).finally(() => { // wqe sill want to play the video even if it fails
            player.loadVideoById({videoId: output.code, suggestedQuality: 'hd720'}); // suggested quality doesn't work
            player.setPlaybackQuality('hd720'); // doesn't seem to force it even when it exists :(
          });
        }).catch((error) => {
          // error, restart browser, update status text
          restartBrowser();
        });
      };

      function startClip(event) {
        event.target.setPlaybackQuality('hd720'); // doesn't seem to force it even when it exists :(
        event.target.playVideo();
      };
  
      // Load the IFrame Player API code asynchronously.
      let tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/player_api';
      let firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  
      // Replace the 'ytplayer' element with an and
      // YouTube player after the API code downloads.
      let player;
      function onYouTubePlayerAPIReady() {
        player = new YT.Player('ytplayer', {
          height: '720',
          width: '1280',
          videoId: currentVideo.code,
          playerVars: {
            vq: 'hd720',
            controls: 0,
          },
          events: {
            'onReady': startClip,
            'onStateChange': (event) => {
              if(event.data === YT.PlayerState.ENDED) {
                // update previous video lastPlayed field
                fetch('http://localhost:3000/videos',
                  {
                    headers: {
                      'Accept': 'application/json',
                      'Content-Type': 'application/json'
                    },
                    method: "POST",
                    body: JSON.stringify({_id: currentVideo._id}),
                 }
                ).finally(() => {
                  nextVideo();
                });
              }
            },
            'onError': (event) => {
              console.log(event);
              const code = event.data;
              if (code === 2) {
                // invalid parameter
              } else if (code === 100) {
                // video removed or private
              } else if (code === 101 || code === 150) {
                // video cannot be embeded
              }
              nextVideo();
            }
          }
        });
      }
    </script>
  </body>
</html>

