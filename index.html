<html>
  <head>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id="ytplayer"></div>
    <script type="text/javascript" src="./node_modules/obs-websocket-js/dist/obs-websocket.min.js"></script>
    <script type="text/javascript" src='./config.js'></script>

    <!-- obs controller -->
    <script>
      const obs = new OBSWebSocket();
      obs.connect({ address: 'localhost:4444'});

      function updateClipInfo(name, channel) {
        obs.send('SetTextFreetype2Properties', {
            source: 'ClipInfo',
            text: `${name}\n${channel}`
          });
          console.log('message sent');
      }
    </script>
    
    <!-- load google youtube api-->
    <script>
      const getNextVideoId = () => 'w_j7HldwIas';
      
      const initialVideo = getNextVideoId();

      function googleApiClientReady() {
        gapi.client.setApiKey(apiKey);
        gapi.client.load('youtube', 'v3').then((output) => {
          getVideoData(initialVideo).then((output) => {
            updateClipInfo(output.title, output.channelTitle);
          }).catch((error) => {
            console.log(error);
          });
        }).catch((error) => {
          console.log(error);
        });
      }

      function getVideoData(videoId) {
        return new Promise((resolve, reject) => {
          gapi.client.youtube.videos.list({
            part: 'snippet',
            id: videoId
          }).then((output) => {
            const data = JSON.parse(output.body).items[0].snippet;
            resolve(data);
          }).catch((error) => {
            reject(error);
          });
        })
      }
    </script>
    <script src='https://apis.google.com/js/client.js?onload=googleApiClientReady'></script>
    
    <script>  
      const nextVideo = async () => {
        // update previous video lastPlayed field

        // get next video id from db
        const videoId = await getNextVideoId();

        // get video info
        getVideoData(videoId).then((output) => {
          // update the ClipInfo text
          updateClipInfo(output.title, output.channelTitle);
          console.log(output)
        }).catch((error) => {
          console.log(error);
        }).finally(() => {
          player.loadVideoById({videoId, suggestedQuality: 'hd1080'});
        });
      };

      const startClip = (event) => {
        event.target.playVideo();
      };
  
      // Load the IFrame Player API code asynchronously.
      let tag = document.createElement('script');
      tag.src = "https://www.youtube.com/player_api";
      let firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  
      // Replace the 'ytplayer' element with an and
      // YouTube player after the API code downloads.
      let player;
      onYouTubePlayerAPIReady = async () => {
        player = new YT.Player('ytplayer', {
          height: '100%',
          width: '100%',
          videoId: initialVideo,
          playerVars: {
            autoplay: 0,
            vq: 'hd1080',
            controls: 0,
          },
          events: {
            'onReady': startClip,
            'onStateChange': (event) => {
              if(event.data === YT.PlayerState.ENDED) {
                nextVideo();
              }
            },
            'onError': (event) => {
            }
          }
        });
      }
    </script>
  </body>
</html>

